<!DOCTYPE html>
<html>

<head>
    <title>清算查询</title>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <link rel="stylesheet" href="asset/dist/lib/weui.min.css">
    <link rel="stylesheet" href="asset/dist/css/jquery-weui.css">
    <link rel="stylesheet" href="asset/dist/fonts/iconfont.css">
    <link rel="stylesheet" href="asset/css/reset.css">
    <link rel="stylesheet" href="asset/css/today.css">
    <script src="asset/dist/lib/zepto.js"></script>
    <script src="asset/js/updown.js"></script>
    <script src="asset/js/common.js"></script>
</head>
<style>
.weui-cells__title+.weui-cells {
    margin-top: 6px;
}

#datalist .weui-cell {
    padding: 6px 15px;
}

#trade_time .weui-label {
    width: 50px;
}

.shijian {
    background: #fff;
    line-height: 20px;
    text-align: center;
    position: relative;
    font-size: 0.8em;
    color: #5b5b5b;
}

.weui-cells {
    margin-bottom: 4px;
}

.tongji {
    display: none;
}

#a,
#b,
#c,
#d,
#e {
    height: 25px;
}

.font1d1 {
    z-index: 3;
    text-align: center;
    /*height:37px;*/
    font-size: 20px;
    color: #fff;
}
</style>

<body>
    <div class="contentt">
        <!--时间查询-->
        <div class="weui-cells__title weui-flex-right on font1d1 text-right">
            <a href="javascript:" class="bt-screen open-popup" data-target="#filtrate" style="color:#fff;">
                        筛选<i class="icon iconfont icon-shaixuan"></i></a>清算查询
        </div>
        <div class="shijian" style="margin-top:42px;"><span id="lbl_begin"></span> 到<span id="lbl_end"></span></div>
        <div class="weui-flex">
            <div class="weui-flex__item weui-flex__sty"><span class="huise-color">交易总笔数</span><span class="red-color" id="a">0</span></div>
            <div class="weui-flex__item weui-flex__sty"><span class="huise-color">消费总金额</span><span class="red-color" id="b">0.00</span></div>
        </div>
        <div class="weui-flex">
            <div class="weui-flex__item weui-flex__sty"><span class="huise-color">手续费总额</span><span class="red-color" id="c">0.00</span></div>
            <div class="weui-flex__item weui-flex__sty"><span class="huise-color">退货总金额</span><span class="red-color" id="d">0.00</span></div>
        </div>
        <div class="weui-flex">
            <div class="weui-flex__item weui-flex__sty"><span class="huise-color">实收总金额</span><span class="red-color" id="e">0.00</span></div>
        </div>
        <div class="page__bd" id="datalist">
            <div class="weui-cells__title weui-flex on" id="time">
                <div class="weui-flex__item">查询时间：<span class="item" id="Launch-time"></span></div>
                <div class="tongji">共<span id="bishu"></span>笔 ￥<span id="je"></span></div>
            </div>
            <div class="weui_panel weui_panel_access" style="margin-bottom:65px;margin-top:1.5em;">
                <div class="weui_panel_bd">
                </div>
            </div>
        </div>
        <div id="filtrate" class="weui-popup__container bt-filtrate">
            <div class="weui-popup__overlay"></div>
            <div class="weui-popup__modal bt-filtrate__modal">
                <div class="bt-filtrate__container">
                    <div class="bt-filtrate__content" id="trade_time">
                        <div class="weui-cells__title weui-flex">
                            <div class="weui-flex__item">交易时间</div>
                            <i class="icon iconfont icon-xiangxiajiantou"></i>
                        </div>
                        <div class="weui-cells weui-cells_form">
                            <div class="weui-cell">
                                <div class="weui-cell__hd">
                                    <label for="ipt_begin" class="weui-label">起始</label>
                                </div>
                                <div class="weui-cell__bd">
                                    <input class="weui-input" id="ipt_begin" type="text" readonly="">
                                </div>
                            </div>
                            <div class="weui-cell">
                                <div class="weui-cell__hd">
                                    <label for="ipt_end" class="weui-label">终止</label>
                                </div>
                                <div class="weui-cell__bd">
                                    <input class="weui-input" id="ipt_end" type="text" readonly="">
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="bt-filtrate__content" id="chosetype">
                        <div class="weui-cells__title weui-flex">
                            <div class="weui-flex__item">选择类型</div>
                            <i class="icon iconfont icon-xiangxiajiantou"></i>
                        </div>
                        <div class="weui-cells weui-cells_radio">
                            <label class="weui-cell weui-check__label" for="x11">
                                <div class="weui-cell__bd">
                                    <p>终端名称</p>
                                </div>
                                <div class="weui-cell__ft">
                                    <input type="radio" class="weui-check" name="search_type" id="x11" value="0" checked="checked">
                                    <span class="weui-icon-checked"></span>
                                </div>
                            </label>
                            <label class="weui-cell weui-check__label" for="x12">
                                <div class="weui-cell__bd">
                                    <p>终端号码</p>
                                </div>
                                <div class="weui-cell__ft">
                                    <input type="radio" name="search_type" class="weui-check" value="1" id="x12">
                                    <span class="weui-icon-checked"></span>
                                </div>
                            </label>
                        </div>
                        <div class="weui-cells">
                            <div class="weui-cell">
                                <div class="weui-cell__bd">
                                    <input class="weui-input" type="text" placeholder="请输入文本" id="search_value">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="weui-flex" id="foobtn">
                    <div class="weui-flex__item">
                        <a id="reset" class="weui-btn weui-btn_default bt-btn__fixed bt-filtrate__btn">重置</a>
                    </div>
                    <div class="weui-flex__item">
                        <a id="confirm" class="weui-btn weui-btn_primary_blue bt-btn__fixed bt-filtrate__btn">确定</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="weui-tabbar">
        <a href="today.html" class="weui-tabbar__item">
            <div class="weui-tabbar__icon">
                <i class="icon iconfont icon-jiaoyi"></i>
            </div>
            <p class="weui-tabbar__label">当日交易</p>
        </a>
        <a href="trade.html" class="weui-tabbar__item" style="display:none;" id="trade_page">
            <div class="weui-tabbar__icon">
                <i class="icon iconfont icon-lishi"></i>
            </div>
            <p class="weui-tabbar__label ">历史交易</p>
        </a>
        <a class="weui-tabbar__item weui-bar__item--on" style="display:none;" id="stlm_page">
            <div class="weui-tabbar__icon">
                <i class="icon iconfont icon-chaxun lanse-color"></i>
            </div>
            <p class="weui-tabbar__label">清算查询</p>
        </a>
    </div>
    <!-- foorer -->
    <div id="totop"><img src="asset/images/totop.png"></div>
    <div id="totalnum" style="display:none"></div>
    <script src="asset/dist/lib/fastclick.js"></script>
    <script src="asset/dist/js/jquery-weui.js"></script>
    <script>
    $(function() {
        FastClick.attach(document.body);
    });
    ! function() {
        var curUrl = parseURL(window.location.href);
        var curWxNo = !!curUrl.params.wxno ? curUrl.params.wxno.trim() : '';
        var curWxName = !!curUrl.params.wxname ? unescape(curUrl.params.wxname.trim()) : '';
        var curRole = !!curUrl.params.role ? curUrl.params.role.trim() : '';

        if (!!curWxNo && !!curRole) {
            sessionStorage.setItem("wxno", curWxNo);
            sessionStorage.setItem("wxname", curWxName);
            sessionStorage.setItem("role", curRole);
        } else {
            curWxNo = !!sessionStorage.getItem("wxno") ? sessionStorage.getItem("wxno").trim() : '';
            curWxName = !!sessionStorage.getItem("wxname") ? sessionStorage.getItem("wxname").trim() : '';
            curRole = !!sessionStorage.getItem("role") ? sessionStorage.getItem("role").trim() : '';

            // double check
            if (!curWxNo || !curRole) {
                $.toptip('异常访问,请在微信公众号内访问该网页', 'error');
                return;
            }
        }

        curRole == 'b' ? $('#trade_page').css('display', 'block') : '';
        curRole == 'a' ? $('#trade_page').css('display', 'block') && $('#stlm_page').css('display', 'block') : '';

        var begin_date = !!curUrl.params.begin_date ? curUrl.params.begin_date.trim() : '';
        var end_date = !!curUrl.params.end_date ? curUrl.params.end_date.trim() : '';
        var search_type = !!curUrl.params.search_type ? curUrl.params.search_type.trim() : '';
        var search_value = !!curUrl.params.search_value ? curUrl.params.search_value.trim() : '';

        // 获取前一天时间
        var today = new Date();
        var yesterday = new Date();
        yesterday.setDate(today.getDate() - 1);



        if (!begin_date || !end_date) {
            begin_date = yesterday.format("yyyy-MM-dd");
            end_date = yesterday.format("yyyy-MM-dd");
        } else {
            begin_date = formatTime(begin_date);
            end_date = formatTime(end_date);
        }

        //获取90天
        var last90 = new Date();
        last90.setDate(yesterday.getDate() - 90);
        var minDate = last90.format("yyyy-MM-dd");
        var maxDate = yesterday.format("yyyy-MM-dd");

        !function init() {
            var a = $("#Launch-time");
            // "查询时间："
            a.html(today.format('yyyy-MM-dd hh:mm:ss'));

            $("#ipt_begin").calendar({
                value: [begin_date],
                dateFormat: 'yyyy-mm-dd',
                minDate: minDate,
                maxDate: maxDate,
                closeOnSelect: true
            });
            $("#ipt_end").calendar({
                value: [end_date],
                dateFormat: 'yyyy-mm-dd',
                minDate: minDate,
                maxDate: maxDate,
                closeOnSelect: true
            });

            $("#lbl_begin").html(begin_date);
            $("#lbl_end").html(end_date);

            $('#search_value').val(unescape(search_value));

            if (!search_type || search_type == '0') {
                $('#x11').prop("checked", true);
            }

            if (search_type == "1") {
                $('#x12').prop("checked", true);
            }
        }();

        //页数 
        var page = 1;
        // 每页展示10个
        var size = 15;
        $('.weui_panel').dropload({
            scrollArea: window,
            autoLoad: true, //自动加载
            domDown: { //上拉
                domClass: 'dropload-down',
                domRefresh: '<div class="dropload-refresh f15 "  style="line-height:2em;text-align:center;"><i class="icon icon-20"></i>上拉加载更多</div>',
                domLoad: '<div class="dropload-load f15"  style="line-height:2em;text-align:center;"><span class="weui-loading"></span>正在加载中...</div>',
                domNoData: '<div class="dropload-noData"  style="line-height:2em;text-align:center;">没有更多数据了</div>'
            },
            loadDownFn: function(me) { //加载更多

                var begindate = begin_date.replaceAll(/-/, "");
                var enddate = end_date.replaceAll(/-/, "");

                var act = appServer + '/stlm';
                $.ajax({
                    type: 'GET',
                    url: act,
                    cache: false,
                    dataType: 'json',
                    data: {
                        "wxno": curWxNo,
                        "begintime": begindate,
                        "endtime": enddate,
                        "search_type": search_type,
                        "search_value": search_value,
                        "page_num": page
                    },
                    success: function(resp) {
                        var arrLen = 0;
                        if (resp.respcode == '00') {
                            arrLen = !!resp.data ? resp.data.length : 0;

                            if (arrLen > 0) {
                                fillData(resp);
                                page++;
                            }
                        } else if (resp.respcode == '02') {
                            $.toast.prototype.defaults.duration = 500000000;
                            $.toast(resp.respmsg, "forbidden");
                        } else {
                            $.toptip(resp.respmsg, 'error');
                        }

                        if (arrLen == 0 || arrLen < size || resp.page_num == resp.page_total) {
                            me.lock();
                            me.noData();
                        }
                        // 每次数据加载完，必须重置
                        me.resetload();
                    },
                    error: function(xhr, type) {
                        $.toptip('网络连接失败', 'error');
                        // 即使加载出错，也得重置
                        me.lock();
                        me.noData();
                        me.resetload();
                    }
                });
            }
        });
    }();

    function fillData(resp) {
        $("#totalnum").html(resp.record_count);

        $("#a").html(fillzero(resp.summary.total_trade_count));
        $("#b").html(fillzero(resp.summary.total_trade_amount));
        $("#c").html(fillzero(resp.summary.total_fee_amount));
        $("#d").html(fillzero(resp.summary.total_refund_amount));
        $("#e").html(fillzero(resp.summary.total_real_amount));
        $("#bishu").html(resp.summary.total_trade_count);
        $("#je").html(fillzero(resp.summary.total_trade_amount));

        var arrLen = resp.data.length;
        if (arrLen >= 0) {
            var html = '';
            for (var i = 0; i < arrLen; i++) {
                var url = "stlmdetail.html?shopid=" + resp.data[n].shopid + "&stlmdate=" + resp.data[n].stlmdate;
                html += '<div class="weui-cells">';
                html += '<a href="' + url + '"><div class="weui-cell">';
                html += '<div class="weui-cell__bd"><p>清算时间</p></div>';
                html += '<div class="weui-cell__ft">' + formatTime(resp.data[i].stlmdate) + '</div>';
                html += '</div>';
                html += '<div class="weui-cell">';
                html += '<div class="weui-cell__bd"><p>终端号</p></div>';
                html += '<div class="weui-cell__ft">' + resp.data[i].termcde + '</div>';
                html += '</div>';
                html += '<div class="weui-cell">';
                html += '<div class="weui-cell__bd"><p>笔数</p></div>';
                html += '<div class="weui-cell__ft">' + resp.data[i].tradecount + '</div>';
                html += '</div>';
                html += '<div class="weui-cell">';
                html += '<div class="weui-cell__bd"><p>消费金额</p></div>';
                html += '<div class="weui-cell__ft">' + fillzero(resp.data[i].tradeamount) + '</div>';
                html += '</div>';
                html += '<div class="weui-cell">';
                html += '<div class="weui-cell__bd"><p>退货金额</p></div>';
                html += '<div class="weui-cell__ft">' + fillzero(resp.data[i].refundamount) + '</div>';
                html += '</div>';
                html += '</a></div>';
            }

            $('.weui_panel_bd').append(html);
        }
    }

    //重置
    $("#reset").click(function() {
        $('#x11').prop('checked', true);
        $("#ipt_begin").val(yesterday.format("yyyy-MM-dd"));
        $("#ipt_end").val(yesterday.format("yyyy-MM-dd"));
        $('#search_value').val('');
    });


    $("#confirm").bind("click", fnMyFunc1 = function() {
        var search_type = $('input[name="search_type"]:checked').val();
        var search_value = escape($("#search_value").val());

        var begindate = $("#ipt_begin").val().replaceAll(/-/, '');
        var enddate = $("#ipt_end").val().replaceAll(/-/, '');

        var url = "stlm.html?";
        url += "begin_date=" + begindate + "&end_date=" + enddate + "&search_type=" + search_type + "&search_value=" + search_value;
        window.location.href = url;
    })

    // 总金额隐藏与显示
    $(window).scroll(function() {
        if ($(window).scrollTop() > 40) {
            $("#totop").css("display", "block");
        } else {
            $("#totop").css("display", "none");
        }
        if ($(window).scrollTop() > 217) {
            $("#time").css({ "position": "fixed", "top": "3.1em", "z-index": "10", "background-color": "#000", "color": "#fff", "width": "93%", "opacity": ".5" })
            $(".tongji").css("display", "block");
        } else {
            $("#time").css({ "position": "absolute", "top": "-1.8em", "background-color": "transparent", "color": "#484848", "width": "90%" });
            $(".tongji").css("display", "none");
        }
    });

    // 回到顶部
    $("#totop").click(function() {
        $("body").scrollTop(0);
    })

    // 确定按钮隐藏
    var h = $(window).height();
    $(window).resize(function() {
        if ($(window).height() < h) {
            $('#foobtn').hide();
        }
        if ($(window).height() >= h) {
            $('#foobtn').show();
        }
    });
    </script>
</body>

</html>